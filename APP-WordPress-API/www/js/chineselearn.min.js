angular.module("chineselearn",["ionic","ngCookies","ngMessages","pascalprecht.translate","tmh.dynamicLocale","toaster","LocalForageModule","chineselearn.controllers","chineselearn.config","chineselearn.directives","chineselearn.filters","chineselearn.services"]).run(["$ionicPlatform","$filter","$timeout","toaster","$rootScope","$interval","$ionicLoading",function(t,e,a,n,o,r,i){if(t.ready(function(){cordova.plugins.Keyboard.disableScroll(!0),window.StatusBar&&!ionic.Platform.isAndroid()&&StatusBar.styleLightContent(),void 0!==typeof analytics?(analytics.startTrackerWithId("UA-46856632-5"),analytics.setUserId(device.uuid)):(console.log("Google Analytics Unavailable"),$rootscope.connectionFails++)}),o.connectionFails=0,r(function(){o.connectionFails>1&&(i.show({template:'<ion-spinner icon="lines" class="spinner-energized"></ion-spinner>'+e("translate")("INTERNET_CONNECTION_NONE")}),a(function(){i.hide(),o.connectionFails=0},5e3))},1e4),ionic.Platform.isAndroid()){var s=!1;t.registerBackButtonAction(function(t){return t.preventDefault(),s?ionic.Platform.exitApp():(s=!0,a(function(){n.pop({type:"error",body:e("translate")("CONFIRM_BEFORE_APP_EXIT"),toasterId:1})},0),a(function(){s=!1},5e3)),!1},101)}}]).config(["$httpProvider","$ionicConfigProvider","tmhDynamicLocaleProvider","$translateProvider","$localForageProvider","$stateProvider","$urlRouterProvider",function(t,e,a,n,o,r,i){t.defaults.useXDomain=!0,e.tabs.position("bottom"),a.localeLocationPattern("locales/angular-locale_{{locale}}.js"),n.useStaticFilesLoader({prefix:"i18n/",suffix:".json"}).registerAvailableLanguageKeys(["de","en","es","fr","hi","ja","pt","ru","zh"],{de:"de","de_*":"de",en:"en","en_*":"en",es:"es","es_*":"es",fr:"fr","fr_*":"fr",hi:"hi","hi_*":"hi",ja:"ja","ja_*":"ja",pt:"pt","pt_*":"pt",ru:"ru","ru_*":"ru",zh:"zh","zh_*":"zh"}).preferredLanguage("en").determinePreferredLanguage().useSanitizeValueStrategy("escapeParameters").useLocalStorage(),o.config({name:"ChineseLearnInfo",storeName:"prefPosts",description:"Let user to keep their preference on ChineseLearnInfo Post(s) on mobile."}),r.state("tab",{url:"/tab","abstract":!0,templateUrl:"templates/tabs.html"}).state("tab.dash",{url:"/dash",views:{"tab-dash":{templateUrl:"templates/tab-dash.html",controller:"DashCtrl"}}}).state("tab.posts",{url:"/posts",cache:!1,views:{"tab-posts":{templateUrl:"templates/tab-posts.html",controller:"PostsCtrl"}}}).state("tab.post-detail",{url:"/posts/:postId",views:{"tab-posts":{templateUrl:"templates/post-detail.html",controller:"PostDetailCtrl"}}}).state("tab.tags",{url:"/tags",cache:!1,views:{"tab-tags":{templateUrl:"templates/tab-tags.html",controller:"TagsCtrl"}}}).state("tab.tag-posts",{url:"/tagposts/:tagSlug/:tagName",views:{"tab-posts":{templateUrl:"templates/tab-posts.html",controller:"PostsCtrl"}}}).state("tab.categories",{url:"/categories",cache:!1,views:{"tab-categories":{templateUrl:"templates/tab-categories.html",controller:"CategoriesCtrl"}}}).state("tab.category-posts",{url:"/categoryposts/:categorySlug/:categoryName",views:{"tab-posts":{templateUrl:"templates/tab-posts.html",controller:"PostsCtrl"}}}).state("tab.areas",{url:"/areas",cache:!1,views:{"tab-areas":{templateUrl:"templates/tab-areas.html",controller:"AreasCtrl"}}}).state("tab.areas-posts",{url:"/areaposts/:areaSlug/:areaName",views:{"tab-posts":{templateUrl:"templates/tab-posts.html",controller:"PostsCtrl"}}}).state("tab.settings",{url:"/settings",views:{"tab-settings":{templateUrl:"templates/tab-settings.html",controller:"SettingsCtrl"}}}),i.otherwise("/tab/dash")}]),angular.module("chineselearn.config",[]).constant("AppConfig",{appName:"Chinese Learn InfoCenter",domainURI:"http://chineselearn.info/",wpAPIURI:"wp-json/wp/v2/",wpAPIKey:"",wpAPISecret:"",wpAPIURIsuffix:"orderby=id&order=asc&per_page=",wpAPIRSlimit:10,wpConnectTimeout:5e3,eeAPIName:"yannicklin@twoudia.com",eeServiceKey:"9ef8dacb-1080-401c-934e-0272a02b96e7",eeAPIURI:"https://api.elasticemail.com/mailer/send",contactForm2Email:"info@chineselearn.info",contactForm2User:"InfoSupport",eeConnectTimeout:1e4,areaList:["tw-taipei-xinbei-keelung","tw-taoyuan-hsinchu-miaoli","tw-taichung-changhua-nantou","tw-yunlin-chiayi-tainan","tw-kaohsiung-pingtung","tw-ilan-hualien-taitung"]}),angular.module("chineselearn.services",[]).factory("DataLoader",["$http","AppSettings",function(t,e){return{get:function(a,n){var o=t({method:"GET",url:e.getURI(a,n),timeout:e.get("wpConnectTimeout")});return o}}}]).factory("EmailSender",["$http","$log","AppSettings","$timeout","toaster","$filter",function(t,e,a,n,o,r){return{send:function(i,s){return t({method:"POST",url:a.get("eeAPIURI"),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8"},transformRequest:function(t){var e=[];for(var a in t)t[a].length>0&&e.push(encodeURIComponent(a)+"="+encodeURIComponent(t[a]));return e.join("&")},data:i,timeout:a.get("eeConnectTimeout")}).then(function(){n(function(){o.pop({type:"info",body:r("translate")("ALERT_MAIL_SENT",{name:s}),toasterId:2})},0)},function(){e.debug("error sending email.")}),null}}}]).factory("PHPJSfunc",function(){return{urlencode:function(t){t=(t+"").toString();var e=encodeURIComponent(t).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+");return e}}}).factory("AppSettings",["AppConfig","$translate","tmhDynamicLocale",function(t,e,a){function n(t){switch(t){case"en":o.languageURI="";break;case"zh":o.languageURI="zh-hant/";break;default:o.languageURI=""}}var o=t;return o.language=e.use(),n(o.language),{change:function(t,r){o[t]=r,"language"==t&&(n(r),e.use(r),a.set(r))},get:function(t){return o[t]},getURI:function(t,e){return e=0==e?o.wpAPIRSlimit:e,t.indexOf("?")<0?o.domainURI+o.languageURI+o.wpAPIURI+t+"?"+o.wpAPIURIsuffix+e:o.domainURI+o.languageURI+o.wpAPIURI+t+"&"+o.wpAPIURIsuffix+e}}}]),angular.module("chineselearn.controllers",[]).controller("DashCtrl",function(){void 0!==typeof analytics&&analytics.trackView("Dashboard")}).controller("PostsCtrl",["$scope","DataLoader","$stateParams","$log","$filter","$ionicLoading","AppSettings","$timeout","$rootScope","$state","$ionicHistory",function(t,e,a,n,o,r,i,s,l,c,d){t.posts=null,t.RSempty=!1;var p=1;t.NextPageIndicator=0,void 0!==typeof analytics&&analytics.trackView("Posts List");var u="posts";a.tagSlug?(u+="?filter[tag]="+a.tagSlug,t.termQS={Type:o("translate")("TAB_TITLE_TAGS"),Term:a.tagName},void 0!==typeof analytics&&analytics.trackEvent("Post List Condition","Tag",a.tagName)):a.categorySlug?(u+="?filter[category_name]="+a.categorySlug,t.termQS={Type:o("translate")("TAB_TITLE_CATEGORIES"),Term:a.categoryName},void 0!==typeof analytics&&analytics.trackEvent("Post List Condition","Category",a.categoryName)):a.areaSlug&&(u+="?filter[tag]="+a.areaSlug,t.termQS={Type:o("translate")("TAB_TITLE_AREAS"),Term:o("translate")("AREAS-"+a.areaName)},void 0!==typeof analytics&&analytics.trackEvent("Post List Condition","AREA",a.areaName)),t.loadPosts=function(){r.show({template:'<ion-spinner icon="ripple" class="spinner-light"></ion-spinner>'+o("translate")("LOADING_TEXT")}),e.get(u,0).then(function(e){0==e.data.length?(t.posts=null,t.RSempty=!0):(t.posts=e.data,e.data.length==i.get("wpAPIRSlimit")&&(p++,t.NextPageIndicator=1)),s(function(){r.hide()},500)},function(e){n.error("error",e),r.hide(),t.RSempty=!0,l.connectionFails++})},t.loadPosts(),t.loadNextPage=function(){r.show({template:'<ion-spinner icon="ripple" class="spinner-light"></ion-spinner>'+o("translate")("LOADING_TEXT")}),t.NextPageIndicator=0,e.get(u+"?page="+p,0).then(function(e){e.data.length>0&&(t.posts=t.posts.concat(e.data),e.data.length==i.get("wpAPIRSlimit")&&(p++,t.NextPageIndicator=1)),s(function(){r.hide()},500),t.$broadcast("scroll.infiniteScrollComplete")},function(e){n.error("error",e),r.hide(),t.RSempty=!0,l.connectionFails++})},t.reload=function(){t.posts=null,t.RSempty=!1;t.NextPageIndicator=0,t.loadPosts()},t.cleanCondition=function(){d.nextViewOptions({disableBack:!0}),c.go("tab.posts")}}]).controller("PostDetailCtrl",["$scope","$stateParams","DataLoader","$log","$filter","$ionicLoading","$ionicHistory","$timeout","$rootScope",function(t,e,a,n,o,r,i,s,l){void 0!==typeof analytics&&analytics.trackView("Single Post"),t.loadPost=function(){r.show({template:'<ion-spinner icon="ripple" class="spinner-light"></ion-spinner>'+o("translate")("LOADING_TEXT")}),a.get("posts/"+e.postId,0).then(function(e){t.post=e.data,s(function(){r.hide()},500)},function(t){n.error("error",t),r.hide(),l.connectionFails++})},t.loadPost(),t.closePost=function(){i.goBack()}}]).controller("TagsCtrl",["AppSettings","$scope","DataLoader","$log","$filter","$ionicLoading","$timeout","$rootScope",function(t,e,a,n,o,r,i,s){e.tags=null,e.RSempty=!1;var l=t.get("areaList");void 0!==typeof analytics&&analytics.trackView("Tags List"),e.loadTags=function(){r.show({template:'<ion-spinner icon="ripple" class="spinner-light"></ion-spinner>'+o("translate")("LOADING_TEXT")}),a.get("tags",100).then(function(a){0==a.data.length?(e.tags=null,e.RSempty=!0):(e.tags=a.data,angular.forEach(l,function(a,n){angular.forEach(e.tags,function(n,o){var r=t.get("languageURI").length>0?a+"-"+t.get("languageURI").replace("/",""):a;r===n.slug&&e.tags.splice(o,1)})}),0==e.tags.length&&(e.RSempty=!0)),i(function(){r.hide()},500)},function(t){n.error("error",t),r.hide(),e.RSempty=!0,s.connectionFails++})},e.loadTags(),e.reload=function(){e.tags=null,e.RSempty=!1;e.NextPageIndicator=0,e.loadTags()}}]).controller("CategoriesCtrl",["$scope","DataLoader","$log","$filter","$ionicLoading","$timeout","$rootScope",function(t,e,a,n,o,r,i){t.categories=null,t.RSempty=!1,void 0!==typeof analytics&&analytics.trackView("Categories List"),t.loadCategories=function(){o.show({template:'<ion-spinner icon="ripple" class="spinner-light"></ion-spinner>'+n("translate")("LOADING_TEXT")}),e.get("categories",100).then(function(e){0==e.data.length?(t.categories=null,t.RSempty=!0):t.categories=e.data,r(function(){o.hide()},500)},function(e){a.error("error",e),o.hide(),t.RSempty=!0,i.connectionFails++})},t.loadCategories(),t.reload=function(){t.categories=null,t.RSempty=!1;t.NextPageIndicator=0,t.loadCategories()}}]).controller("AreasCtrl",["AppSettings","$state","$scope","DataLoader","$log","$filter","$ionicLoading","$timeout","$rootScope",function(t,e,a,n,o,r,i,s,l){var c={},d=t.get("areaList");void 0!==typeof analytics&&analytics.trackView("Area Map"),i.show({template:'<ion-spinner icon="ripple" class="spinner-light"></ion-spinner>'+r("translate")("LOADING_TEXT")}),n.get("tags",100).then(function(a){a.data.length>0&&angular.forEach(d,function(e,n){var o=t.get("languageURI").length>0?e+"-"+t.get("languageURI").replace("/",""):e;angular.forEach(a.data,function(t,a){o==t.slug&&(c[e]=t.count)})}),s(function(){var a=.8*window.screen.width,n=.8*window.screen.height,o=d3.select("#map").append("svg").attr("width",a).attr("height",n);d3.json("./geo/twMetropolitanArea2016.topo.json",function(r,i){function s(a){var n="tw-"+a.properties.Name+(t.get("languageURI").length>0?"-"+t.get("languageURI").replace("/",""):"");e.go("tab.areas-posts",{areaSlug:n,areaName:a.properties.Name})}var l=topojson.feature(i,i.objects.MACollection);for(idx=l.features.length-1;idx>=0;idx--)l.features[idx].properties.postCount=c["tw-"+l.features[idx].properties.Name]>0?c["tw-"+l.features[idx].properties.Name]:0;var d=d3.geo.mercator().scale(1).translate([0,0]),p=d3.geo.path().projection(d),u=p.bounds(l),g=.95/Math.max((u[1][0]-u[0][0])/a,(u[1][1]-u[0][1])/n),m=[(a-g*(u[1][0]+u[0][0]))/2,(n-g*(u[1][1]+u[0][1]))/2];d.scale(g).translate(m),o.selectAll("path").data(l.features).enter().append("path").attr("d",p).attr("id",function(t){return t.properties.County_ID}).style("fill","darkgrey").style("stroke-width","2").style("stroke","white").on("click",s),o.selectAll("label").data(l.features).enter().append("text").attr("transform",function(t){return"translate("+p.centroid(t)+")"}).attr("text-anchor","middle").attr("dy","0.35em").attr("font-size","2em").attr("fill","red").text(function(t){return t.properties.postCount}).on("click",s)}),i.hide()},500)},function(t){o.error("error",t),i.hide(),l.connectionFails++})}]).controller("SettingsCtrl",["$scope","$translate","tmhDynamicLocale","AppSettings","$ionicHistory","EmailSender","$filter","$window",function(t,e,a,n,o,r,i,s){t.forms={},t.ctForm={},t.settings={language:e.use()},void 0!==typeof analytics&&analytics.trackView("Settings"),t.narrowformat=1,t.recalDimensions=function(){s.innerWidth<s.innerHeight||s.innerWidth<479?t.narrowformat=1:t.narrowformat=0,void 0!==typeof analytics&&analytics.trackEvent("Device","Orientation","toPortrait",t.narrowformat)},t.recalDimensions(),angular.element(s).bind("resize",function(){t.$apply(function(){t.recalDimensions()})}),t.$watch("settings.language",function(){t.settings.language!=n.get("language")&&(n.change("language",t.settings.language),o.clearCache(),o.clearHistory(),void 0!==typeof analytics&&analytics.trackEvent("Interface","Language",t.settings.language))}),t.formSubmit=function(){var e={username:n.get("eeAPIName"),api_key:n.get("eeServiceKey"),from:t.ctForm.ctEmail,from_name:t.ctForm.ctName,to:n.get("contactForm2Email"),subject:"Message via Mobile APP - "+n.get("appName")+", "+i("date")(Date.now(),"yyyy-MM-dd HH:mm Z"),body_html:'<table style="border: 1px dashed black; border-collapse: collapse;"><caption>'+n.get("appName")+'</caption><tfoot style="color: red;"><tr><td style="border: 1px dashed black; padding: 5px;">Time</td><td style="border: 1px dashed black; padding: 5px;">'+i("date")(Date.now(),"yyyy-MM-dd HH:mm Z")+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">SPEC</td><td style="border: 1px dashed black; padding: 5px;">Platform: '+device.platform+", Version: "+device.version+", Manufacturer: "+device.manufacturer+", Model: "+device.model+", UUID: "+device.uuid+'</td></tr></tfoot><tbody><tr><td style="border: 1px dashed black; padding: 5px;">Name</td><td style="border: 1px dashed black; padding: 5px;">'+t.ctForm.ctName+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">Email</td><td style="border: 1px dashed black; padding: 5px;">'+t.ctForm.ctEmail+'</td></tr><tr><td style="border: 1px dashed black; padding: 5px;">Message</td><td style="border: 1px dashed black; padding: 5px;">'+t.ctForm.ctMessage+"</td></tr></tbody></table>",body_text:"TEXT VERSION: "+t.ctForm.ctMessage};r.send(e,t.ctForm.ctName),t.ctForm={},t.forms.contactForm.$setPristine(),void 0!==typeof analytics&&analytics.trackEvent("Email","ContactUs")}}]),angular.module("chineselearn.directives",[]).directive("gpRadio",function(){return{restrict:"AE",require:"ngModel",scope:{model:"=ngModel",value:"=gpRadio"},link:function(t,e,a,n){e.addClass("button"),e.on("click",function(e){t.$apply(function(){n.$setViewValue(t.value)})}),t.$watch("model",function(a){e.removeClass("button-positive"),a===t.value&&e.addClass("button-positive")})}}}).directive("keyInput",function(){return function(t,e,a){e.bind("keydown keypress",function(e){13===e.which&&(t.$apply(function(){t.$eval(a.keyInput)}),e.preventDefault())})}}).directive("keyboardHide",["$window",function(t){return{restrict:"A",link:function(e,a,n){angular.element(t).bind("native.keyboardshow",function(){a.addClass("hide")}),angular.element(t).bind("native.keyboardhide",function(){a.removeClass("hide")})}}}]).directive("keyboardHide4tabs",["$window",function(t){return{restrict:"A",link:function(e,a,n){angular.element(t).bind("native.keyboardshow",function(){a.addClass("tabs-item-hide")}),angular.element(t).bind("native.keyboardhide",function(){a.removeClass("tabs-item-hide")})}}}]),angular.module("chineselearn.filters",[]).filter("partRemove",["$sce",function(t){return function(e,a){var n=document.createElement("div");n.innerHTML=e;for(var o=n.getElementsByTagName(a),r=o.length;r>0;r--)o[r-1].parentNode.removeChild(o[r-1]);return t.trustAsHtml(n.outerHTML)}}]).filter("unicode",["$sce",function(t){return function(e){return t.trustAsHtml(e)}}]).filter("lengthLimit",["AppSettings",function(t){return function(e,a){if(angular.isUndefined(a)||null===a||""===a)switch(t.get("language")){case"ja":case"zh":a=50;break;default:a=100}return String(e).length<=a?e:String(e).substr(0,a)+" ... "}}]).filter("unescapeHTML",function(){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return function(e){return angular.forEach(t,function(t,a){e=String(e).replace(new RegExp(t,"gi"),a)}),e}});